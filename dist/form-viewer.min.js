angular.module("mwFormViewer",["ngSanitize","ui.bootstrap","ng-sortable","pascalprecht.translate"]),angular.module("mwFormViewer").directive("mwPriorityList",function(){return{replace:!0,restrict:"AE",require:"^mwFormQuestion",scope:{question:"=",questionResponse:"=",readOnly:"=?",options:"=?"},templateUrl:"mw-priority-list.html",controllerAs:"ctrl",bindToController:!0,controller:function(){function e(e){if(e)for(var t=0;t<e.length;t++){var n=e[t];n.priority=t+1}}function t(e){e.sort(function(e,t){return e.priority-t.priority})}var n=this;this.$onInit=function(){n.questionResponse.priorityList||(n.questionResponse.priorityList=[]),n.idToItem={},t(n.questionResponse.priorityList),n.availableItems=[],n.question.priorityList.forEach(function(e){n.idToItem[e.id]=e;var t=n.questionResponse.priorityList.some(function(t){return e.id==t.id});t||n.availableItems.push({priority:null,id:e.id})}),n.allItemsOrdered=0==n.availableItems.length||null;var s={disabled:n.readOnly,ghostClass:"beingDragged"};n.orderedConfig=angular.extend({},s,{group:{name:"A",pull:!1,put:["B"]},onEnd:function(t,s){e(n.questionResponse.priorityList)}}),n.availableConfig=angular.extend({},s,{sort:!1,group:{name:"B",pull:["A"],put:!1},onEnd:function(t,s){e(n.questionResponse.priorityList),n.allItemsOrdered=0==n.availableItems.length||null}})},1===angular.version.major&&angular.version.minor<5&&this.$onInit()},link:function(e,t,n,s){var o=e.ctrl;o.print=s.print}}}),angular.module("mwFormViewer").directive("mwFormViewer",["$rootScope","$q",function(e,t){return{replace:!0,restrict:"AE",scope:{formData:"=",responseData:"=",templateData:"=?",readOnly:"=?",options:"=?",formStatus:"=?",onSubmit:"&",api:"=?"},templateUrl:"mw-form-viewer.html",controllerAs:"ctrl",bindToController:!0,controller:["$timeout","$interpolate",function(n,s){function o(){r.formData.pages.sort(function(e,t){return e.number-t.number})}var r=this;r.$onInit=function(){r.defaultOptions={nestedForm:!1,autoStart:!1,disableSubmit:!1,elementButtons:[]},r.options=angular.extend({},r.defaultOptions,r.options),r.submitStatus="NOT_SUBMITTED",r.formSubmitted=!1,o(),r.pageIdToPage={},r.formData.pages.forEach(function(e){r.pageIdToPage[e.id]=e}),r.buttons={prevPage:{visible:!1,disabled:!1},nextPage:{visible:!1,disabled:!1},submitForm:{visible:!1,disabled:!1}},r.resetPages(),r.api&&(r.api.reset=function(){for(var e in r.responseData)r.responseData.hasOwnProperty(e)&&delete r.responseData[e];r.buttons.submitForm.visible=!1,r.buttons.prevPage.visible=!1,r.buttons.nextPage.visible=!1,r.currentPage=null,n(r.resetPages,0)})},r.callback=function(e,t,n){e.preventDefault(),e.stopPropagation(),t.callback&&"function"==typeof t.callback&&t.callback(n)},r.filter=function(e,t){return!e.filter||"function"!=typeof e.filter||e.filter(t)},r.submitForm=function(){r.formSubmitted=!0,r.submitStatus="IN_PROGRESS",r.setCurrentPage(null);var e=r.onSubmit();e.then(function(){r.submitStatus="SUCCESS"})["catch"](function(){r.submitStatus="ERROR"})},r.updatePromiseText=function(){if(r.currentPage&&r.currentPage.elements&&Array.isArray(r.currentPage.elements)&&r.currentPage.elements.length>0&&r.options.elementButtons&&Array.isArray(r.options.elementButtons)&&r.options.elementButtons.length>0)for(var e=0;e<r.currentPage.elements.length;e++)for(var n=0;n<r.options.elementButtons.length;n++)!function(e,n){r.options.elementButtons[e].mwText={},r.options.elementButtons[e].text&&"function"==typeof r.options.elementButtons[e].text?(r.options.elementButtons[e].mwTextPromise=r.options.elementButtons[e].text(r.currentPage.elements[n]),t.when(r.options.elementButtons[e].mwTextPromise,function(t){void 0,r.options.elementButtons[e].mwText[r.currentPage.elements[n].question.id]=t},function(){r.options.elementButtons[e].mwText[r.currentPage.elements[n].question.id]=""})):r.options.elementButtons[e].mwText[r.currentPage.elements[n].question.id]=r.options.elementButtons[e].text}(n,e)},r.setCurrentPage=function(e){return r.currentPage=e,e?(r.setDefaultNextPage(),void r.initResponsesForCurrentPage()):(r.buttons.submitForm.visible=!1,r.buttons.prevPage.visible=!1,void(r.buttons.nextPage.visible=!1))},r.setDefaultNextPage=function(){var e=r.formData.pages.indexOf(r.currentPage);if(r.currentPage.isFirst=0==e,r.currentPage.isLast=e==r.formData.pages.length-1,r.buttons.submitForm.visible=r.currentPage.isLast,r.buttons.prevPage.visible=!r.currentPage.isFirst,r.buttons.nextPage.visible=!r.currentPage.isLast,r.currentPage.isLast?r.nextPage=null:r.nextPage=r.formData.pages[e+1],r.currentPage.pageFlow){var t=!1;r.currentPage.pageFlow.formSubmit?(r.nextPage=null,t=!0):r.currentPage.pageFlow.page?(r.nextPage=r.pageIdToPage[r.currentPage.pageFlow.page.id],r.buttons.nextPage.visible=!0):r.currentPage.isLast&&(r.nextPage=null,t=!0),r.buttons.submitForm.visible=t,r.buttons.nextPage.visible=!t}},r.initResponsesForCurrentPage=function(){r.currentPage.elements.forEach(function(e){var t=e.question;t&&!r.responseData[t.id]&&(r.responseData[t.id]={})})},r.beginResponse=function(){r.formData.pages.length>0&&(r.setCurrentPage(r.formData.pages[0]),e.$broadcast("mwForm.pageEvents.pageCurrentChanged",{currentPage:r.currentPage}),r.updatePromiseText())},r._resetPages=function(){r.prevPages=[],r.currentPage=null,r.nextPage=null,r.formSubmitted=!1},r.resetPages=function(){r._resetPages(),r.options.autoStart&&r.beginResponse()},r.goToPrevPage=function(){var t=r.prevPages.pop();r.setCurrentPage(t),r.updateNextPageBasedOnAllAnswers(),e.$broadcast("mwForm.pageEvents.pageCurrentChanged",{currentPage:r.currentPage}),r.updatePromiseText()},r.goToNextPage=function(){r.prevPages.push(r.currentPage),r.updateNextPageBasedOnAllAnswers(),r.setCurrentPage(r.nextPage),e.$broadcast("mwForm.pageEvents.pageCurrentChanged",{currentPage:r.currentPage}),r.updatePromiseText()},r.updateNextPageBasedOnAllAnswers=function(){r.currentPage.elements.forEach(function(e){r.updateNextPageBasedOnPageElementAnswers(e)}),r.buttons.submitForm.visible=!r.nextPage,r.buttons.nextPage.visible=!!r.nextPage},r.updateNextPageBasedOnPageElementAnswers=function(e){var t=e.question;t&&t.pageFlowModifier&&t.offeredAnswers.forEach(function(e){e.pageFlow&&r.responseData[t.id].selectedAnswer==e.id&&(e.pageFlow.formSubmit?r.nextPage=null:e.pageFlow.page&&(r.nextPage=r.pageIdToPage[e.pageFlow.page.id]))})},r.onResponseChanged=function(e){r.setDefaultNextPage(),r.updateNextPageBasedOnAllAnswers()},r.print=function(e){return e&&r.templateData?s(e)(r.templateData):e},1===angular.version.major&&angular.version.minor<5&&r.$onInit()}],link:function(t,n,s){var o=t.ctrl;o.formStatus&&(o.formStatus.form=o.form),t.$on("mwForm.pageEvents.changePage",function(t,n){if("undefined"!=typeof n.page&&n.page<o.formData.pages.length){o._resetPages();for(var s=0;s<n.page;s++)o.prevPages.push(o.formData.pages[s]);var r=o.formData.pages[n.page];o.setCurrentPage(r),e.$broadcast("mwForm.pageEvents.pageCurrentChanged",{currentPage:r}),o.updateNextPageBasedOnAllAnswers(),o.updatePromiseText()}})}}}]),angular.module("mwFormViewer").factory("FormQuestionId",function(){var e=0;return{next:function(){return++e}}}).directive("mwFormQuestion",function(){return{replace:!0,restrict:"AE",require:"^mwFormViewer",scope:{question:"=",questionResponse:"=",readOnly:"=?",options:"=?",onResponseChanged:"&?"},templateUrl:"mw-form-question.html",controllerAs:"ctrl",bindToController:!0,controller:["$timeout","FormQuestionId",function(e,t){var n=this;this.$onInit=function(){n.id=t.next(),"radio"==n.question.type?(n.questionResponse.selectedAnswer||(n.questionResponse.selectedAnswer=null),n.questionResponse.other&&(n.isOtherAnswer=!0)):"checkbox"==n.question.type?(n.questionResponse.selectedAnswers&&n.questionResponse.selectedAnswers.length?n.selectedAnswer=!0:n.questionResponse.selectedAnswers=[],n.questionResponse.other&&(n.isOtherAnswer=!0)):"grid"==n.question.type?n.question.grid.cellInputType||(n.question.grid.cellInputType="radio"):"division"==n.question.type?(n.computeDivisionSum=function(){n.divisionSum=0,n.question.divisionList.forEach(function(e){0==n.questionResponse[e.id]||n.questionResponse[e.id]?n.divisionSum+=n.questionResponse[e.id]:(n.questionResponse[e.id]=null,n.divisionSum+=0)})},n.computeDivisionSum()):"date"!=n.question.type&&"datetime"!=n.question.type&&"time"!=n.question.type||n.questionResponse.answer&&(n.questionResponse.answer=new Date(n.questionResponse.answer)),n.isAnswerSelected=!1,n.initialized=!0},n.selectedAnswerChanged=function(){delete n.questionResponse.other,n.isOtherAnswer=!1,n.answerChanged()},n.otherAnswerRadioChanged=function(){void 0,n.isOtherAnswer&&(n.questionResponse.selectedAnswer=null),n.answerChanged()},n.otherAnswerCheckboxChanged=function(){n.isOtherAnswer||delete n.questionResponse.other,n.selectedAnswer=!(!n.questionResponse.selectedAnswers.length&&!n.isOtherAnswer)||null,n.answerChanged()},n.toggleSelectedAnswer=function(e){n.questionResponse.selectedAnswers.indexOf(e.id)===-1?n.questionResponse.selectedAnswers.push(e.id):n.questionResponse.selectedAnswers.splice(n.questionResponse.selectedAnswers.indexOf(e.id),1),n.selectedAnswer=!(!n.questionResponse.selectedAnswers.length&&!n.isOtherAnswer)||null,n.answerChanged()},n.answerChanged=function(){n.onResponseChanged&&n.onResponseChanged()},1===angular.version.major&&angular.version.minor<5&&this.$onInit()}],link:function(e,t,n,s){var o=e.ctrl;o.print=s.print}}}),angular.module("mwFormViewer").directive("mwFormConfirmationPage",function(){return{replace:!0,restrict:"AE",require:"^mwFormViewer",scope:{submitStatus:"=",confirmationMessage:"=",readOnly:"=?"},templateUrl:"mw-form-confirmation-page.html",controllerAs:"ctrl",bindToController:!0,controller:function(){},link:function(e,t,n,s){var o=e.ctrl;o.print=s.print}}});